---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

const allPosts = await getCollection('blog');

// Build a map of tag -> post count
const tagCounts = new Map<string, number>();

allPosts.forEach(post => {
  if (post.data.categories) {
    post.data.categories.forEach(cat => {
      tagCounts.set(cat, (tagCounts.get(cat) || 0) + 1);
    });
  }
});

// Sort tags alphabetically
const sortedTags = Array.from(tagCounts.entries()).sort((a, b) => a[0].localeCompare(b[0]));

// Helper to slugify category names for URLs
function slugify(text: string): string {
  return text.toLowerCase()
    .replace(/&amp;/g, 'and')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}
---

<BaseLayout title="Tags" description="Browse posts by tag">
  <div class="page">
    <h1 class="page-title">Tags</h1>

    {sortedTags.length === 0 ? (
      <p>No tags found.</p>
    ) : (
      <ul class="tag-list">
        {sortedTags.map(([tag, count]) => (
          <li>
            <a href={`/tags/${slugify(tag)}`}>
              {tag}
              <span class="tag-count">({count})</span>
            </a>
          </li>
        ))}
      </ul>
    )}
  </div>
</BaseLayout>
